#!/usr/bin/env python3
import argparse
import collections
import datetime
import pathlib
import subprocess
import sys
import time


def run_command(args: list[str], cwd: pathlib.Path = None) -> str:
    try:
        return subprocess.check_output(
            args, text=True, stderr=subprocess.DEVNULL, cwd=cwd
        ).strip()
    except subprocess.CalledProcessError:
        return ""


def analyze_repository(repo_path: pathlib.Path) -> None:
    print("repository analytics")

    if not run_command(["git", "rev-parse", "--is-inside-work-tree"], cwd=repo_path):
        print("error: not a git repository.")
        sys.exit(1)

    total_commits_str = run_command(["git", "rev-list", "--count", "HEAD"], cwd=repo_path)
    total_commits = int(total_commits_str) if total_commits_str else 0

    cmd = ["git", "log", "--numstat", "--pretty=format:COMMIT|%ct|%an"]
    process = subprocess.Popen(
        cmd, stdout=subprocess.PIPE, text=True, errors="replace", cwd=repo_path
    )

    first_ts = float("inf")
    last_ts = 0
    contributors: dict[str, int] = collections.defaultdict(int)
    file_churn: dict[str, int] = collections.defaultdict(int)
    added_lines = 0
    removed_lines = 0

    for line in process.stdout:
        line = line.strip()
        if not line:
            continue

        if line.startswith("COMMIT|"):
            parts = line.split("|")
            if len(parts) >= 3:
                try:
                    ts = int(parts[1])
                    author = parts[2]
                    if ts < first_ts:
                        first_ts = ts
                    if ts > last_ts:
                        last_ts = ts
                    contributors[author] += 1
                except ValueError:
                    continue
        else:
            parts = line.split(maxsplit=2)
            if len(parts) == 3:
                try:
                    add = int(parts[0]) if parts[0] != "-" else 0
                    rem = int(parts[1]) if parts[1] != "-" else 0
                    filename = parts[2]
                    added_lines += add
                    removed_lines += rem
                    file_churn[filename] += 1
                except ValueError:
                    continue

    process.wait()

    now = time.time()
    if first_ts == float("inf"):
        print("no commits found.")
        return

    days_active = (now - first_ts) / 86400
    if days_active < 1:
        days_active = 1.0

    print(f"average commits per day: {total_commits / days_active:.2f}")
    print(f"average commits per week: {(total_commits / days_active) * 7:.2f}")
    print(f"average commits per month: {(total_commits / days_active) * 30:.2f}")
    print()
    print(f"number of unique contributors: {len(contributors)}")
    print()
    print("top 10 committers:")
    top_contributors = sorted(contributors.items(), key=lambda x: x[1], reverse=True)[:10]
    for author, count in top_contributors:
        print(f"{count:>5}  {author}")

    print()
    print(f"last commit date: {datetime.datetime.fromtimestamp(last_ts)}")
    print(f"first commit date: {datetime.datetime.fromtimestamp(first_ts)}")
    print()
    print("total lines of code added/removed (entire history):")
    print(f"added: {added_lines}")
    print(f"removed: {removed_lines}")
    print(f"net change: {added_lines - removed_lines}")
    print()
    print("top 10 most frequently changed files:")
    top_files = sorted(file_churn.items(), key=lambda x: x[1], reverse=True)[:10]
    for fname, count in top_files:
        print(f"{count:>5} {fname}")

    branches = run_command(["git", "branch", "-r"], cwd=repo_path).splitlines()
    print()
    print(f"number of active branches: {len(branches)}")

    all_files = run_command(["git", "ls-files"], cwd=repo_path).splitlines()
    total_files = len(all_files)
    print(f"total number of files: {total_files}")
    print()
    print("number of files by extension and percentage contribution:")
    extensions: dict[str, int] = collections.defaultdict(int)
    for f in all_files:
        if "." in f:
            ext = f.rsplit(".", 1)[1]
            extensions[ext] += 1
        else:
            extensions["[no extension]"] += 1

    top_extensions = sorted(extensions.items(), key=lambda x: x[1], reverse=True)
    for ext, count in top_extensions:
        percentage = (count / total_files) * 100
        print(f"{count:>5} ({percentage:.2f}%) {ext}")


def main() -> None:
    parser = argparse.ArgumentParser(description="analyze git repository statistics")
    parser.add_argument(
        "path",
        type=pathlib.Path,
        nargs="?",
        default=pathlib.Path.cwd(),
        help="path to git repository (default: current directory)",
    )
    args = parser.parse_args()

    if not args.path.exists():
        print(f"error: path does not exist: {args.path}")
        sys.exit(1)

    if not args.path.is_dir():
        print(f"error: path is not a directory: {args.path}")
        sys.exit(1)

    analyze_repository(args.path)


if __name__ == "__main__":
    main()
